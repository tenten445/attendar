<!DOCTYPE html>
<html lang="jp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン付きカレンダー</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // JWTデコード関数
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Google Identity Services コールバック関数
        window.handleCredentialResponse = function (response) {
            console.log("Googleログインのレスポンス:", response); // ログを追加
            const jwtToken = response.credential;

            if (!jwtToken) {
                console.error("JWTトークンが取得できませんでした。");
                return;
            }

            // JWTをデコードしてユーザー情報を取得
            const user = parseJwt(jwtToken);
            console.log("デコードされたユーザー情報:", user); // ログを追加

            // ローカルストレージにトークンを保存
            localStorage.setItem('jwtToken', jwtToken);
            localStorage.setItem('userName', user.name); // ユーザー名を保存
            // ログイン成功時にカレンダーを表示
            showCalendarForUser(user);
        };

        // Google Sheets API 認証の初期化
        function loadClient() {
            gapi.client.init({
                apiKey: 'YOUR_API_KEY',
                clientId: 'YOUR_CLIENT_ID',
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
            }).then(() => {
                console.log('Google Sheets APIが初期化されました');
            });
        }

        // Google Sheets APIの読み込み
        function gapiInit() {
            gapi.load('client:auth2', loadClient);
        }

        // Googleログイン後にカレンダーを表示
        function showCalendarForUser(user) {
            document.getElementById("user-info").innerText = `ようこそ、${user.name}さん！`;
            document.getElementById("calendar-container").style.display = "block";
            document.getElementById("login-container").style.display = "none";

            // カレンダー初期化
            if (typeof showCalendar === "function") {
                showCalendar(year, month); // main.js のカレンダー関数を呼び出す
            } else {
                console.error("showCalendar 関数が定義されていません");
            }
        }

        // ページロード時のログイン状態確認
        document.addEventListener("DOMContentLoaded", function () {
            gapiInit(); // ← これを追加
            const jwtToken = localStorage.getItem('jwtToken');
            console.log("ローカルストレージから取得したJWTトークン:", jwtToken); // ログを追加

            if (jwtToken) {
                const user = parseJwt(jwtToken);
                console.log("自動ログインのユーザー情報:", user); // ログを追加
                showCalendarForUser(user);
            }

            // ログアウト機能
            document.getElementById("logout-btn").addEventListener("click", function () {
                localStorage.removeItem("jwtToken");
                document.getElementById("calendar-container").style.display = "none";
                document.getElementById("login-container").style.display = "block";
            });
        });

        // 出欠情報をスプレッドシートに書き込む関数
        function writeToSheet(date, userName, attendance) {
            const sheetId = 'YOUR_SPREADSHEET_ID';  // あなたのスプレッドシートのID
            const range = 'Sheet1!A:C';  // データを書き込む範囲

            const valueRangeBody = {
                values: [
                    [date, userName, attendance]
                ]
            };

            // Google Sheets APIを使ってデータを書き込む
            gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: sheetId,
                range: range,
                valueInputOption: 'RAW',
                resource: valueRangeBody
            }).then((response) => {
                console.log('データがスプレッドシートに書き込まれました。');
            }, (error) => {
                console.error('エラーが発生しました: ' + error);
            });
        }

        // 出欠情報を選択した日にちに基づいて保存する
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("calendar_td")) {
                // すべてのセルから 'selected' を削除
                document.querySelectorAll(".calendar_td").forEach(td => {
                    td.classList.remove("selected");
                });

                // クリックされたセルに 'selected' を追加
                e.target.classList.add("selected");
                const clickedDateStr = e.target.getAttribute('data-date');  // 名前変更

                // 出欠取得
                const selectedAttendance = document.querySelector('input[name="attendance"]:checked')?.value;
                const userName = localStorage.getItem('userName');
                if (!userName) {
                    alert("ログインしていません。");
                    return;
                }

                // スプレッドシートに書き込み
                if (selectedAttendance !== "未回答") {
                    writeToSheet(clickedDateStr, userName, selectedAttendance);
                }
            }
        });

    </script>
</head>

<body>
    <!-- ログインセクション -->
    <div id="login-container">
        <h1>ログインしてください</h1>
        <div id="g_id_onload"
            data-client_id="YOUR_CLIENT_ID"
            data-login_uri=""
            data-auto_prompt="false"
            data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="sign_in_with"
            data-shape="rectangular"
            data-logo_alignment="left">
        </div>
    </div>

    <!-- カレンダーセクション -->
    <div id="calendar-container" style="display: none;">
        <h2 id="user-info"></h2>
        <div class="button-wrapper">
            <button id="prev" type="button">前の月</button>
            <button id="next" type="button">次の月</button>
        </div>
        <div id="calendar"></div>
        <button id="logout-btn">ログアウト</button>
    </div>

    <!-- main.js を読み込み -->
    <script src="main.js"></script>
    <script src="login.js"></script>
</body>

</html>
