<!DOCTYPE html>
<html lang="jp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン付きカレンダー</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // JWTデコード関数
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Google Identity Services コールバック関数
        window.handleCredentialResponse = function (response) {
            console.log("Googleログインのレスポンス:", response); // ログを追加
            const jwtToken = response.credential;

            if (!jwtToken) {
                console.error("JWTトークンが取得できませんでした。");
                return;
            }

            // JWTをデコードしてユーザー情報を取得
            const user = parseJwt(jwtToken);
            console.log("デコードされたユーザー情報:", user); // ログを追加

            // ローカルストレージにトークンを保存
            localStorage.setItem('jwtToken', jwtToken);

            // ログイン成功時にカレンダーを表示
            showCalendar(user);
        };

        // カレンダー表示関数
        function showCalendar(user) {
            document.getElementById("user-info").innerText = `ようこそ、${user.name}さん！`;
            document.getElementById("calendar-container").style.display = "block";
            document.getElementById("login-container").style.display = "none";
        }

        // ページロード時のログイン状態確認
        document.addEventListener("DOMContentLoaded", function () {
            const jwtToken = localStorage.getItem('jwtToken');
            console.log("ローカルストレージから取得したJWTトークン:", jwtToken); // ログを追加

            if (jwtToken) {
                const user = parseJwt(jwtToken);
                console.log("自動ログインのユーザー情報:", user); // ログを追加
                showCalendar(user);
            }

            // ログアウト機能
            document.getElementById("logout-btn").addEventListener("click", function () {
                localStorage.removeItem("jwtToken");
                document.getElementById("calendar-container").style.display = "none";
                document.getElementById("login-container").style.display = "block";
            });
        });
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
    <!-- ログインセクション -->
    <div id="login-container">
        <h1>ログインしてください</h1>
        <div id="g_id_onload"
            data-client_id="775352245980-qg5lq2jcetci9mv4fa4a5oa4522hlef9.apps.googleusercontent.com"
            data-login_uri=""
            data-auto_prompt="false"
            data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="sign_in_with"
            data-shape="rectangular"
            data-logo_alignment="left">
        </div>
    </div>

    <!-- カレンダーセクション -->
    <div id="calendar-container" style="display: none;">
        <h2 id="user-info"></h2>
        <div class="button-wrapper">
            <button id="prev" type="button">前の月</button>
            <button id="next" type="button">次の月</button>
        </div>
        <div id="calendar"></div>
        <button id="logout-btn">ログアウト</button>
    </div>

    <!-- main.js を読み込み -->
    <script src="main.js"></script>
</body>

</html>
