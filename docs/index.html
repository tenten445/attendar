<!DOCTYPE html>
<html lang="jp">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ログイン付きカレンダー</title>
  <link rel="stylesheet" href="style.css">

  <!-- Google Identity & API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>

<body>
  <!-- ログインセクション -->
  <div id="login-container">
    <h1>ログインしてください</h1>
    <div id="login-button"></div> <!-- Googleログインボタン -->
  </div>

  <!-- カレンダーセクション -->
  <div id="calendar-container" style="display: none;">
    <h2 id="user-info"></h2>
    <div class="button-wrapper">
      <button id="prev" type="button">前の月</button>
      <button id="next" type="button">次の月</button>
    </div>
    <div id="calendar"></div>
    <button id="logout-btn">ログアウト</button>
  </div>

  <!-- スクリプト群 -->
  <script src="main.js"></script>
  <script src="login.js"></script>

  <script>
    // ページロード時のログイン状態確認・ログアウト設定
    document.addEventListener("DOMContentLoaded", function () {
      const jwtToken = localStorage.getItem('jwtToken');

      if (jwtToken) {
        const user = parseJwt(jwtToken);
        document.getElementById("login-container").style.display = "none";
        document.getElementById("calendar-container").style.display = "block";
        document.getElementById("user-info").textContent = `ようこそ、${user.name}さん！`;
        if (typeof showCalendar === "function") {
          showCalendar(year, month);
        }
      }

      document.getElementById("logout-btn").addEventListener("click", function () {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userName");
        document.getElementById("calendar-container").style.display = "none";
        document.getElementById("login-container").style.display = "block";
      });
    });

    // JWTトークンをデコードする関数（login.jsで未定義ならここで定義）
    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
  </script>
</body>
</html>
