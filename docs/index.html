<!DOCTYPE html>
<html lang="jp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン付きカレンダー</title>
    <link rel="stylesheet" href="style.css">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Google Identity Servicesのコールバック関数
            function handleCredentialResponse(response) {
                const jwtToken = response.credential;

                // JWTをデコードしてユーザー情報を取得
                const user = parseJwt(jwtToken);

                // ローカルストレージにトークンを保存
                localStorage.setItem('jwtToken', jwtToken);

                // ログイン成功時にカレンダーを表示
                showCalendar(user);
            }

            function parseJwt(token) {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }

            function showCalendar(user) {
                // ユーザー情報を表示
                document.getElementById("user-info").innerText = `ようこそ、${user.name}さん！`;

                // カレンダーとボタンを表示
                document.getElementById("calendar-container").style.display = "block";
                document.getElementById("login-container").style.display = "none";
            }

            // ページ読み込み時にログイン状態を確認
            const jwtToken = localStorage.getItem('jwtToken');
            if (jwtToken) {
                const user = parseJwt(jwtToken);
                showCalendar(user);
            }

            // ログアウト機能
            document.getElementById("logout-btn").addEventListener("click", function () {
                localStorage.removeItem("jwtToken");
                document.getElementById("calendar-container").style.display = "none";
                document.getElementById("login-container").style.display = "block";
            });

            // Googleのコールバック関数をグローバルに設定
            window.handleCredentialResponse = handleCredentialResponse;
        });
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
    <!-- ログインセクション -->
    <div id="login-container">
        <h1>ログインしてください</h1>
        <div id="g_id_onload"
            data-client_id="775352245980-qg5lq2jcetci9mv4fa4a5oa4522hlef9.apps.googleusercontent.com"
            data-login_uri=""
            data-auto_prompt="false"
            data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin"
            data-type="standard"
            data-size="large"
            data-theme="outline"
            data-text="sign_in_with"
            data-shape="rectangular"
            data-logo_alignment="left">
        </div>
    </div>

    <!-- カレンダーセクション -->
    <div id="calendar-container" style="display: none;">
        <div class="button-wrapper">
            <button id="prev" type="button">前の月</button>
            <button id="next" type="button">次の月</button>
        </div>
        <div id="calendar"></div>
        <button id="logout-btn">ログアウト</button>
        <script src="main.js"></script>
    </div>
</body>

</html>
