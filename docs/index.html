<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å‡ºæ¬ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 5px; }
    .today { background-color: yellow; }
    .holiday { color: red; }
    .selected { border: 2px solid #000; }
    .attendance-participate::after { content: 'ğŸ”´'; }
    .attendance-absent::after { content: 'ğŸ”µ'; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <button id="login-btn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
  <div>
    <button id="prev">å‰æœˆ</button>
    <button id="next">æ¬¡æœˆ</button>
  </div>
  <div id="calendar"></div>
  <div id="participant-list"></div>

  <script>
    const SHEET_ID = '1W61LsGM7uS9RwKgI5KFJ4reulIC0s5aNvb2QLDOo4KA';
    const SHEET_NAME = 'ã‚·ãƒ¼ãƒˆ1';
    const API_KEY = 'AIzaSyB_-I2BgPAhXK6Tv4UE4HkMvIV7u3XGK5U';
    const CLIENT_ID = '775352245980-g6dm3nv0pcpn9q1ga0s0c03r755669gb.apps.googleusercontent.com';

    const weeks = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const holidays = new Map([
      ['2025/4/29', 'æ˜­å’Œã®æ—¥'], // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
    ]);

    let date = new Date();
    let year = date.getFullYear();
    let month = date.getMonth() + 1;
    let tokenClient;
    let attendanceData = new Map();

    window.onload = () => {
      gapi.load("client", async () => {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
        });

        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: "https://www.googleapis.com/auth/spreadsheets",
          callback: async (tokenResponse) => {
            if (tokenResponse.error) {
              console.error("èªè¨¼ã‚¨ãƒ©ãƒ¼:", tokenResponse);
              return;
            }
            attendanceData = await fetchAttendanceData();
            showCalendar(year, month);
          }
        });

        document.getElementById("login-btn").addEventListener("click", () => {
          tokenClient.requestAccessToken();
        });
      });
    };

    async function fetchAttendanceData() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: `${SHEET_NAME}!A:C`,
        });
        const rows = response.result.values;
        const map = new Map();
        if (rows && rows.length > 0) {
          rows.forEach(([date, name, status]) => {
            if (!map.has(date)) map.set(date, []);
            map.get(date).push({ name, status });
          });
        }
        return map;
      } catch (e) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
        return new Map();
      }
    }

    function showCalendar(year, month) {
      const container = document.getElementById("calendar");
      container.innerHTML = "";

      const start = new Date(year, month - 1, 1);
      const end = new Date(year, month, 0);
      const endDay = end.getDate();
      const startDay = start.getDay();
      const today = new Date();
      const todayStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;

      let day = 1;
      let html = `<h2>${year}å¹´ ${month}æœˆ</h2><table><thead><tr>`;
      for (let w of weeks) html += `<th>${w}</th>`;
      html += `</tr></thead><tbody>`;

      for (let w = 0; w < 6; w++) {
        html += "<tr>";
        for (let d = 0; d < 7; d++) {
          if (w === 0 && d < startDay || day > endDay) {
            html += "<td></td>";
          } else {
            const dateStr = `${year}/${month}/${day}`;
            const isHoliday = holidays.has(dateStr);
            const classes = ["calendar_td"];
            if (dateStr === todayStr) classes.push("today");
            if (isHoliday) classes.push("holiday");

            const dayData = attendanceData.get(dateStr) || [];
            const participants = dayData.filter(p => p.status === "å‚åŠ ");
            const participantCount = participants.length;

            html += `<td class="${classes.join(" ")}" data-date="${dateStr}">
              <div>${day}</div>
              ${participantCount > 0 ? `<div style="font-size: 0.8em;">${participantCount}äºº</div>` : ""}
              ${isHoliday ? `<small>${holidays.get(dateStr)}</small>` : ""}
            </td>`;
            day++;
          }
        }
        html += "</tr>";
      }
      html += "</tbody></table>";
      html += `
        <div>
          <label><input type="radio" name="attendance" value="å‚åŠ ">å‚åŠ </label>
          <label><input type="radio" name="attendance" value="æ¬ å¸­">æ¬ å¸­</label>
          <label><input type="radio" name="attendance" value="æœªå›ç­”" checked>æœªå›ç­”</label>
        </div>`;
      container.innerHTML = html;
      highlightToday();
    }

    function highlightToday() {
      const today = new Date();
      const str = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
      const cell = document.querySelector(`td[data-date="${str}"]`);
      if (cell) cell.classList.add("selected");
    }

    document.addEventListener("click", async (e) => {
      if (e.target.closest(".calendar_td")) {
        document.querySelectorAll(".calendar_td").forEach(td => td.classList.remove("selected"));
        const cell = e.target.closest(".calendar_td");
        cell.classList.add("selected");

        const dateStr = cell.getAttribute("data-date");
        const list = attendanceData.get(dateStr) || [];
        const names = list.filter(p => p.status === "å‚åŠ ").map(p => p.name).join("<br>");
        document.getElementById("participant-list").innerHTML = `<strong>${dateStr} ã®å‚åŠ è€…:</strong><br>${names}`;
      }

      if (e.target.name === "attendance") {
        const cell = document.querySelector(".calendar_td.selected");
        if (!cell) return;
        const status = e.target.value;
        cell.classList.remove("attendance-participate", "attendance-absent");
        if (status === "å‚åŠ ") cell.classList.add("attendance-participate");
        if (status === "æ¬ å¸­") cell.classList.add("attendance-absent");

        const userName = localStorage.getItem("userName") || "åŒ¿å";
        const dateStr = cell.getAttribute("data-date");
        if (status !== "æœªå›ç­”") {
          writeToSheet(dateStr, userName, status);
        }
      }
    });

    async function writeToSheet(date, name, status) {
      try {
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: SHEET_ID,
          range: `${SHEET_NAME}!A:C`,
          valueInputOption: "USER_ENTERED",
          insertDataOption: "INSERT_ROWS",
          resource: {
            values: [[date, name, status]],
          },
        });
        console.log("æ›¸ãè¾¼ã¿å®Œäº†");
        attendanceData = await fetchAttendanceData();
        showCalendar(year, month);
      } catch (e) {
        console.error("æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      }
    }

    document.getElementById("prev").addEventListener("click", () => {
      month--;
      if (month < 1) {
        month = 12;
        year--;
      }
      showCalendar(year, month);
    });

    document.getElementById("next").addEventListener("click", () => {
      month++;
      if (month > 12) {
        month = 1;
        year++;
      }
      showCalendar(year, month);
    });
  </script>
</body>
</html>
